package tfg.uniovi.servicesTask;

import org.activiti.engine.delegate.DelegateExecution;
import org.activiti.engine.delegate.JavaDelegate;
import org.springframework.web.client.RestTemplate;

import tfg.uniovi.model.dto.VulnerabilityDTO;
import tfg.uniovi.repository.Vulnerabilities;

public class RestExecutor extends AbstractExecutor implements JavaDelegate {
	
	/**
	 * Método para hacer la consulta a la API para obtener los datos de todas las
	 * potenciales vulnerabilidades encontradas
	 */
	@Override
	public void execute(DelegateExecution execution) throws Exception {		
		// Se obtienen los datos del cms y version del paso anterior del flujo
		String cms = (String) execution.getVariable("cms");
		double cmsVersion = (double) execution.getVariable("cmsVersion");
		
		RestTemplate restTemplate = new RestTemplate();
		String url = createURL(cms, cmsVersion);
		VulnerabilityDTO[] k = restTemplate.getForObject(url, VulnerabilityDTO[].class, 200);
		for (int i=0; i<k.length; i++) {
			Vulnerabilities.getInstance().addVulnerability(k[i]);
		}
	}
	
	/**
	 * Método privado para crear la consulta a la API para la obtención de los datos
	 * de la vulnerabilidad encontrada con el cms y su versión
	 * @param cms
	 * @param cmsVersion
	 * @return URL para la consulta a la API
	 */
	private String createURL(String cms, double cmsVersion) {
		String url = "http://cve.circl.lu/api/search/";
		url += cms.toLowerCase() + "/" + cms.toLowerCase() + ":" + cmsVersion;		
		return url;
	}

}

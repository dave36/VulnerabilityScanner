package tfg.uniovi.servicesTask;

import org.activiti.engine.delegate.DelegateExecution;
import org.activiti.engine.delegate.JavaDelegate;
import org.springframework.web.client.RestTemplate;

import tfg.uniovi.model.dto.VulnerabilityDTO;
import tfg.uniovi.repository.Vulnerabilities;

public class ServerComparatorExecutor extends AbstractExecutor implements JavaDelegate {
	
	/**
	 * Método para hacer la consulta a la API para obtener los datos de todas las
	 * potenciales vulnerabilidades encontradas
	 */
	@Override
	public void execute(DelegateExecution execution) throws Exception {		
		// Se obtienen los datos del cms y version del paso anterior del flujo
		String server = (String) execution.getVariable("name");
		String serverVersion = (String) execution.getVariable("version");
		
		if (server != null && serverVersion != null) {
			RestTemplate restTemplate = new RestTemplate();
			String url = createURL(server, serverVersion);
			VulnerabilityDTO[] k = restTemplate.getForObject(url, VulnerabilityDTO[].class, 200);
			for (int i=0; i<k.length; i++) {
				Vulnerabilities.getInstance().addVulnerability(k[i]);
			}
		}
	}
	
	/**
	 * Método privado para crear la consulta a la API para la obtención de los datos
	 * de la vulnerabilidad encontrada con el servidor y su versión
	 * @param server
	 * @param serverVersion
	 * @return URL para la consulta a la API
	 */
	private String createURL(String server, String serverVersion) {
		String url = "http://cve.circl.lu/api/search/";
		String[] servidorIIS = null;
		if (server.startsWith("Microsoft")) {
			servidorIIS = server.split("-");
			url += servidorIIS[0].toLowerCase() + "/" + servidorIIS[1].toLowerCase() + ":" + serverVersion;
		}
		else {
			url += server + "/" + server + ":" + serverVersion;
		}
		return url;
	}
	
	

}

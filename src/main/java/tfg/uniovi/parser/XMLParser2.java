package tfg.uniovi.parser;

import java.io.File;
import java.io.FileNotFoundException;
import java.util.ArrayList;
import java.util.List;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;

import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.Node;
import org.w3c.dom.NodeList;

import tfg.uniovi.model.Server;

public class XMLParser2 {

	public static Server parse(String fileName, String tagName, String nodeTagName) throws FileNotFoundException {
		try {
			DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();
			DocumentBuilder db = dbf.newDocumentBuilder();
			File file = new File("src/main/resources/outputs/" + fileName);
			
			if (file.exists()) {
				Document doc = db.parse(file);
				Element docElem = doc.getDocumentElement();
				NodeList list = docElem.getElementsByTagName(tagName);
				
				Server server = new Server();
				boolean found = false;
				
				if (list != null && list.getLength() > 0) {
					for (int i=0; i < list.getLength(); i++) {
						Node node = list.item(i);
						if (node.getNodeType() == Node.ELEMENT_NODE) {
							NodeList nameList = ((Element) node).getElementsByTagName("name");
							NodeList versionList = ((Element) node).getElementsByTagName("version");
							if (nameList.getLength() > 0 && versionList.getLength() > 0) {
								String name = nameList.item(0).getChildNodes().item(0).getNodeValue();
								String version = versionList.item(0).getChildNodes().item(0).getNodeValue();
								if (name.startsWith("Microsoft") || name.startsWith("Apache") || name.startsWith("nginx")) {
									server.setName(name);
									server.setVersion(version);
									found = true;
								}
								if (name.startsWith("Wordpress") || name.startsWith("Joomla")) {
									server.setCms(name);
									server.setCmsVersion(version);
									found = true;
								}
							}
						}
					}
					if (found != true)
						return null;
				}
				return server;
			} else {
				System.err.println("El fichero " + fileName + " no contiene ning√∫n elemento con la etiqueta " + tagName);
			}
		} catch (Exception e) {
			throw new FileNotFoundException("El fichero " + fileName + " no existe");
		}
		return null;
	}
	
}
